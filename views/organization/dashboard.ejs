<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch/dist/geosearch.css" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet-fullscreen/dist/leaflet.fullscreen.css" /> 


    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f4f4f7; /* A light grayish background */
        }
    
        .btn-success {
            background-color: #2ecc71; /* A vibrant green for success actions */
        }
    
        .btn-success:hover {
            background-color: #27ae60;
        }
    
        .alert-warning {
            background-color: #f39c12; /* A vibrant orange for warnings */
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Card Styles */
        .card {
            height: 100%;
            transition: transform 0.2s;
            cursor: pointer;
            border-radius: 10px;
            overflow: hidden;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            box-shadow: 0px 0px 15px rgba(0,0,0,0.1); /* Shadow for depth */
            transition: transform 0.3s ease; /* Transition for hover effect */
        }
        .card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .card:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transform: translateY(-5px); /* Small lift effect on hover */   
        }

        .card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 10px 10px 0 0;
        }

        .card-body {
            padding: 20px; 
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%; /* This will ensure all cards within the column will have the same height */
        }

        .card-info {
            display: flex;
            justify-content: space-between;
        }
        
        .col-md-4 {
            display: flex;
        }
        
        .status-icon {
            margin-left: 10px;
            vertical-align: middle;
        }
        
        .status-open {
            color: #2ecc71; /* Vibrant green for open status */
        }
        
        .status-closed {
            color: #e74c3c; /* Vibrant red for closed status */
        }
        .btn {
            margin-top: 10px;
        }
        
        .dashboard-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-card {
            height: 100%;
            transition: transform 0.2s;
            cursor: pointer;
            border-radius: 10px;
            overflow: hidden;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .map-container {
            width: 100%;
            height: 400px;
            z-index: 1000 !important;
            border: 1px solid #ccc;
        }

        .leaflet-container {
            max-width: none !important;
            width: 100% !important;
        } 
        
    .leaflet-control-fullscreen {
        z-index: 1001 !important; 
    }

        .btn-enhanced {
            background-color: #34495e; /* A smooth dark blue shade */
            color: #fff; /* White text */
            border-radius: 5px; /* Rounded corners */
            border: none; /* Removing the default border */
            padding: 12px 20px; /* Adjust the padding for a better appearance */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* A subtle shadow for depth */
            transition: transform 0.3s ease, box-shadow 0.3s ease; /* Smooth transition effect for hover */
        }

        .btn-enhanced:hover {
            transform: translateY(-3px); /* Move the button slightly up when hovered */
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.2); /* Increase the shadow size on hover */
        }

        .btn-enhanced:focus {
            outline: none; /* Removing the default focus outline */
            box-shadow: 0 0 0 3px rgba(52, 73, 94, 0.3); /* Add a blue glow around the button when it's focused */
        }

       
    </style>
</head>

<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="/organization/dashboard">Dashboard</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav mr-auto">  
                <li class="nav-item">
                <a class="nav-link" href="/organization/donationsList">Donations</a>
                </li>
                <li class="nav-item">
                <a class="nav-link" href="/organization/pledgeBasket">Pledge Basket</a>
                </li>  
                <li class="nav-item">
                <a class="nav-link" href="/organization/faq">FAQ</a>
                </li>
                <li class="nav-item">
                <a class="nav-link" href="/organization/account">Account</a>
                </li>
            </ul> 
            <form class="form-inline my-2 my-lg-0" method="post" action="/organization/logout">
                <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Logout</button>
            </form>
        </div>
    </nav>


    <div class="dashboard-container mt-4">
        <h2>Drop Points</h2>
        <button type="button" class="btn btn-secondary btn-enhanced mb-3" data-toggle="modal" data-target="#donationGuideModal">
            View Donation Points Guide
        </button>
        

          <!-- Modal Structure Starts Here -->
        <div class="modal fade" id="donationGuideModal" tabindex="-1" role="dialog" aria-labelledby="donationGuideModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                <h5 class="modal-title" id="donationGuideModalLabel">Donation Points Guide</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                </div>
                <div class="modal-body"> 
                    <div class="container">
                        <div class="jumbotron">
                            <h1>Donation Points Guide</h1>
                            <p class="lead">Earn points with each donation to boost your organization's impact!</p>
                        </div>

                        <div class="accordion" id="pointsAccordion">
                            <!-- Peripheral Types Section -->
                            <div class="card">
                                <div class="card-header" id="headingOne">
                                <h2 class="mb-0">
                                    <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                    Types of Peripherals
                                    </button>
                                </h2>
                                </div>
                                <div id="collapseOne" class="collapse show" aria-labelledby="headingOne" data-parent="#pointsAccordion">
                                <div class="card-body">
                                    <ul>
                                    <li><strong>Input Devices:</strong> Includes Mouse and Keyboard. Earn <span class="badge badge-primary">0.5 point per item</span>.</li>
                                    <li><strong>Storage Devices:</strong> HDD, SSD, and Optical Drives fall under this category. <span class="badge badge-primary">1 point per item</span>.</li>
                                    <li><strong>Memory and Processing:</strong> Consists of RAM, Processors, and Motherboards. <span class="badge badge-primary">1.5 points per item</span>.</li>
                                    <li><strong>Graphics and Video:</strong> Graphic Cards, Monitors, and Webcams are part of this category. <span class="badge badge-primary">2 points per item</span>.</li>
                                    <li><strong>Power and Cooling:</strong> Includes Power Supplies and Cooling Fans. <span class="badge badge-primary">1 point per item</span>.</li>
                                    <li><strong>Network and Sound:</strong> Covers Network Cards and Sound Cards. <span class="badge badge-primary">1 point per item</span>.</li>
                                    <li><strong>Whole Systems:</strong> Laptops and Desktops fall under this category. <span class="badge badge-primary">3 points per item</span>.</li>
                                    </ul>            
                                </div>
                                </div>
                            </div> 
                            <!-- Condition Section -->
                            <div class="card">
                                <div class="card-header" id="headingTwo">
                                <h2 class="mb-0">
                                    <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                    Condition
                                    </button>
                                </h2>
                                </div>
                                <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#pointsAccordion">
                                <div class="card-body">
                                    <ul>
                                    <li>New: <span class="badge badge-success">1 bonus point</span></li>
                                    <li>Used but Working: <span class="badge badge-warning">0.5 bonus points</span></li>
                                    </ul>
                                </div>
                                </div>
                            </div>
                            <!-- Quantity Section -->
                            <div class="card">
                                <div class="card-header" id="headingThree">
                                <h2 class="mb-0">
                                    <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                    Quantity
                                    </button>
                                </h2>
                                </div>
                                <div id="collapseThree" class="collapse" aria-labelledby="headingThree" data-parent="#pointsAccordion">
                                <div class="card-body">
                                    <ul>
                                    <li>10 to 49 items: <span class="badge badge-info">3 bonus points</span></li>
                                    <li>50 or more items: <span class="badge badge-info">5 bonus points</span></li>
                                    </ul>
                                </div>
                                </div>
                            </div> 
                        </div> 
                        <!-- Penalty Alert -->
                        <div class="alert alert-danger" role="alert">
                            <h4 class="alert-heading">Important:</h4>
                            <p>If the items you donated do not match the claimed information, point deductions may apply. For example, if an item is claimed as 'New' but appears to be 'Used', points will be recalculated accordingly.</p>
                        </div> 
                        <!-- Penalty Details -->
                        <section>
                            <h4>Penalties</h4>
                            <ul>
                                <li><strong>Incorrect Item Condition:</strong> <span class="badge badge-danger">-1 point per item</span></li>
                                <li><strong>Incorrect Quantity:</strong> <span class="badge badge-danger">-2 points</span></li>
                            </ul>
                        </section> 
                        <!-- Computation Section -->
                        <section>
                            <h4>Computation Formula</h4>
                            <p>To give you a clear understanding of how points are calculated, here is the formula:</p>
                            <pre>
        <code>
            Total Points = ((Base Points per Item + Condition Bonus per Item) x Quantity) + Quantity Bonus (if applicable)
        </code>
                            </pre>
                            <p>For example:</p>
                            <ul>
                                <li>If you are donating 5 'Whole Systems' that are 'Used but Working', your points would be calculated as follows: <br> <code>(3 (Base for Whole Systems) + 0.5 (Condition Bonus)) x 5 (Quantity) = 17.5</code></li>
                                <li>If you are donating 10 'Input Devices' that are 'New', your points would be calculated as follows: <br> <code>(0.5 (Base for Input Devices) + 1 (Condition Bonus)) x 10 (Quantity) + 3 (Quantity Bonus) = 28</code></li>
                            </ul>
                        </section> 
                    </div>
                </div>
                <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
            </div>
        </div>
        <!-- Modal Structure Ends Here -->
  

        <!-- Search Bar -->
        <input type="text" id="search" aria-label="Search Drop Points" placeholder="Search Drop Points..." class="form-control mb-3">
 
        <!-- Drop Points rendering using a loop -->
        <div class="row" id="dropPointsContainer">
            <% dropPoints.forEach(point => { %>
                <div class="col-md-4">
                    <div class="card mb-3" data-toggle="modal" data-target="#detailsModal-<%= point.id %>"> 
                        <div class="card-body">
                            <h5 class="card-title"><%= point.name %></h5>
                            
                            <p class="drop-point">
                                <i class="fas fa-sun"></i> <span id="openingTime-<%= point.id %>"><%= point.openingTime %></span>
                                <span style="margin: 0 20px;">to</span> 
                                <span id="closingTime-<%= point.id %>"><%= point.closingTime %></span> <i class="fas fa-moon"></i>
                                
                                <!-- Placeholder for Status -->
                                <span class="status" id="status-<%= point.id %>">
                                    <!-- We will populate this with JavaScript later -->
                                </span>
                            </p>
                            
                            <p><strong>Contact: <br></strong> <%= point.manager ? point.manager.phoneNumber : 'N/A' %></p> <!-- Displaying phone as a representative contact, adjust as needed -->      
                            <p><strong>Email:</strong> <%= point.manager ? point.manager.email : 'N/A' %></p>
                        </div>
                        
                        <!-- Donate button -->
                        <% if(point.canDonate) { %>
                            <form action="/organization/donationForm" method="POST">
                                <input type="hidden" name="dropPointId" value="<%= point.id %>">
                                <button type="submit" class="btn btn-success btn-block">Donate</button>
                            </form> 
                        <% } else { %>
                            <p class="alert alert-warning">You have a pending donation. Please complete it before donating again.</p>
                        <% } %>                    
                    </div>
                    
                    <!-- Details Modal for this particular point -->
                    <div class="modal fade" id="detailsModal-<%= point.id %>" data-point-id="<%= point.id %>" data-location="<%= point.location %>">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h4 class="modal-title"><%= point.name %></h4>
                                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                                </div>
                                <div class="modal-body row">
                                    <!-- Left Side -->
                                    <div class="col-md-6">
                                        <p><strong>Location:</strong> <%= point.location %></p>
                                        <p><strong>Description:</strong> <%= point.description %></p> 
                                    </div>
                
                                    <!-- Right Side - Map Placeholder -->
                                    <div class="col-md-6">
                                        <div class="map-container" id="map-<%= point.id %>"></div>
                                    </div> 

                                    
                                </div>
                            </div>
                        </div>
                    </div>
 
                </div>
            <% }); %>
        </div>


    </div> 
    
    
    <!-- Scripts - In Order -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- Load Leaflet and plugins ONCE and AFTER Bootstrap -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-geosearch/dist/geosearch.umd.js"></script>
    <script src="https://unpkg.com/leaflet-fullscreen/dist/Leaflet.fullscreen.min.js"></script>

    <script>
        $(document).ready(function() {
            var maps = {};

            $('.modal').each(function() {
                var $modal = $(this);
                var pointId = $modal.data('point-id');
                var location = $modal.data('location');

                var mapId = 'map-' + pointId;
                if ($('#' + mapId).length) {
                    maps[mapId] = L.map(mapId, {
                        fullscreenControl: true,
                        fullscreenControlOptions: {
                            position: 'topleft' // this will position the fullscreen button at the top left corner of the map. You can adjust as needed.
                        }
                    }).setView([0, 0], 13);

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(maps[mapId]);

                    var provider = new GeoSearch.OpenStreetMapProvider();

                    provider.search({ query: location }).then(function(result) {
                        if (result && result[0]) {
                            var coordinates = [result[0].y, result[0].x];
                            maps[mapId].setView(coordinates, 13);
                            L.marker(coordinates).addTo(maps[mapId]).bindPopup(location);
                        } else {
                            console.error("No results found for location:", location);
                        }
                    }).catch(function(error) {
                        console.error("Error searching for location", location, ":", error);
                    });
                }
            });

            $('.modal').on('shown.bs.modal', function(e) {
                var mapId = 'map-' + $(this).data('point-id');
                if (maps[mapId]) {
                    maps[mapId].invalidateSize();
                }
            });
        });
    </script>

    
 
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        function isNowBetweenTimes(start, end) {
            const now = new Date();
            const [startHour, startMinute] = start.split(':').map(Number);
            const [endHour, endMinute] = end.split(':').map(Number);

            const startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), startHour, startMinute);
            const endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), endHour, endMinute);

            return now >= startDate && now <= endDate;
        }

        const dropPoints = document.querySelectorAll('.drop-point');

        dropPoints.forEach(dropPoint => {
            const pointId = dropPoint.querySelector('span[id^="openingTime-"]').id.split('-')[1];
            const openingTime = document.getElementById(`openingTime-${pointId}`).textContent.trim();
            const closingTime = document.getElementById(`closingTime-${pointId}`).textContent.trim();

            const statusElement = dropPoint.querySelector('.status');
            if (isNowBetweenTimes(openingTime, closingTime)) {
                statusElement.innerHTML = '<i class="fas fa-check-circle status-icon status-open"></i> Open';
            } else {
                statusElement.innerHTML = '<i class="fas fa-times-circle status-icon status-closed"></i> Closed';
            }
        });
    });
 

    $("#search").on("input", function() {
        const query = $(this).val().toLowerCase();
        $(".card").each(function() {
            const pointName = $(this).find(".card-title").text().toLowerCase();
            if (pointName.includes(query)) {
                $(this).parent().show();
            } else {
                $(this).parent().hide();
            }
        });
    });
 
    // Change the button event listener to this:
    document.querySelectorAll('.btn.btn-success').forEach(button => {
        button.addEventListener('click', function(event) { 
            event.stopPropagation();
        });
    });

    </script>
</body>
</html>
