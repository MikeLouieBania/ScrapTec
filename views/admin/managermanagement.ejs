<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manager Management</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
    }

    .sidebar {
      height: 100%;
      width: 60px;
      position: fixed;
      top: 0;
      left: 0;
      background-color: #6499E9;
      padding-top: 20px;
      transition: 0.5s;
      z-index: 2;
    }

    .sidebar:hover {
      width: 200px;
    }

    .sidebar a {
      margin-top: 25px;
      display: flex;
      align-items: center;
      padding: 10px 20px;
      color: #fff;
      text-decoration: none;
      transition: background-color 0.3s;
      font-weight: bold;
    }

    .sidebar a:hover {
      background-color: #4477CE;
    }

    .sidebar a .material-icons {
      margin-right: 10px;
    }

    .sidebar a::after {
      content: attr(data-label);
      display: none;
    }

    .sidebar:hover a::after {
      display: inline;
    }

    .main-content {
      padding-left: 70px;
      padding: 20px;
      transition: 0.5s;
    }

    @media screen and (max-width: 768px) {
      .main-content {
        padding-left: 60px;
      }
    }

    .table-responsive {
      margin-top: 20px;
    }

    .modal-dialog {
      max-width: 800px;
    }

    .modal-header {
      background: #007bff;
      color: #fff;
    }

    .modal-body {
      background: #f8f9fa;
    }

    .modal-footer {
      background: #f8f9fa;
    }

    .form-control {
      font-size: 14px;
    }

    .btn-primary {
      background-color: #007bff;
      border: none;
    }

    .btn-primary:hover {
      background-color: #0056b3;
    }

    .search-section {
      padding: 15px 0;
    }

    .search-input {
      margin-bottom: 10px;
    } 

    .details-button {
      background-color: #007bff;
      border-color: #007bff;
      color: white;
    }

    .details-button:hover {
      background-color: #0056b3;
      border-color: #004085;
    }

    #detailTabsContent .tab-pane {
      max-height: 400px; /* Adjust height as needed */
      overflow-y: scroll;
    }

    /* Style for modal tabs */
    .nav-tabs .nav-item.show .nav-link, .nav-tabs .nav-link.active {
      color: #495057;
      background-color: #fff;
      border-color: #dee2e6 #dee2e6 #fff;
    }
  </style>

</head>

<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <a href="/admin/dashboard" data-label="Dashboard"><span class="material-icons">dashboard</span></a>
    <a href="/admin/organizationmanagement" data-label="Organization Management"><span
        class="material-icons">business_center</span></a>
    <a href="/admin/droppointmanagement" data-label="Drop Point Management"><span
        class="material-icons">place</span></a>
    <a href="/admin/managermanagement" data-label="Manager Management"><span
        class="material-icons">supervisor_account</span></a>
    <a href="/admin/usermanagement" data-label="User Management"><span class="material-icons">group</span></a>
    <a href="/admin/logout" data-label="Logout"><span class="material-icons">logout</span></a>
  </div>
  <div class="main-content ml-200">
    <div class="container">
      <!-- Search and Filter Section -->
      <div class="search-section">
        <input type="text" id="searchInput" class="form-control search-input" placeholder="Search by Name, Email."> 
      </div>
      
      <!-- Manager Management Table -->
      <table class="table mt-4">
        <thead>
          <!-- Row for the Manager Management title and button -->
          <tr>
            <th colspan="6" class="w-75 text-left">Manager Management</th>
            <!-- Increase the width of this cell to 75% of the table width -->
            <th class="text-right w-25">
              <button type="button" class="btn btn-primary reg-button" data-toggle="modal"
                data-target="#registerManagerModal">
                Register a Manager
              </button>
            </th>
          </tr>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Contact No.</th>
            <th>Address</th>
            <th>Assigned Status</th>
            <th>Details</th>
        
          </tr>

        </thead>

        <tbody>
          <!-- Populate table rows with drop point data -->
          <% let counter=1; %>
            <% managers.forEach(manager=> { %>
              <tr>
                <td>
                  <%= counter++ %>
                </td>
                <td>
                  <%= manager.firstName %>
                    <%= manager.firstName %>
                </td>
                <td>
                  <%= manager.email %>
                </td>
                <td>
                  <%= manager.phoneNumber %>
                </td>
                <td>
                  <%= manager.address %>
                </td>
                <td>
                  <%= manager.isAssigned ? "Assigned" : "Not Assigned" %>
                </td> 
                <td> 
                  <button type="button" class="btn details-button" data-toggle="modal" data-target="#detailsModal-<%= manager.id %>" data-manager-id="<%= manager.id %>">
                    View Details
                  </button>
                  
                </td>
              </tr>

              <!-- Modal for Manager Details -->
              <div class="modal fade" id="detailsModal-<%= manager.id %>" tabindex="-1" role="dialog" aria-labelledby="detailsModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg" role="document">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="detailsModalLabel">Details for <%= manager.firstName %> <%= manager.lastName %></h5>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>
                    <div class="modal-body">
                      <ul class="nav nav-tabs" id="detailTabs" role="tablist">
                        <li class="nav-item">
                          <a class="nav-link active" id="logs-tab" data-toggle="tab" href="#logs-<%= manager.id %>" role="tab" aria-controls="logs" aria-selected="true">Logs</a>
                        </li>
                        <li class="nav-item">
                          <a class="nav-link" id="donations-tab" data-toggle="tab" href="#donations-<%= manager.id %>" role="tab" aria-controls="donations" aria-selected="false">Donations</a>
                        </li>
                        <li class="nav-item">
                          <a class="nav-link" id="feedback-tab" data-toggle="tab" href="#feedback-<%= manager.id %>" role="tab" aria-controls="feedback" aria-selected="false">Feedback</a>
                        </li>
                      </ul>
                      <div class="tab-content" id="detailTabsContent">
                        <div class="tab-pane fade show active" id="logs-<%= manager.id %>" role="tabpanel" aria-labelledby="logs-tab">
                          <!-- Logs content will be loaded here -->
                        </div>
                        <div class="tab-pane fade" id="donations-<%= manager.id %>" role="tabpanel" aria-labelledby="donations-tab">
                          <!-- Donations content will be loaded here -->
                        </div>
                        <div class="tab-pane fade" id="feedback-<%= manager.id %>" role="tabpanel" aria-labelledby="feedback-tab">
                          <!-- Feedback content will be loaded here -->
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

               
              <% }) %>
        </tbody>
      </table>

      <div class="clearfix">
        <ul class="pagination">
          <% if(currentPage > 1) { %>
            <li class="page-item">
              <a href="/admin/managermanagement?page=<%= currentPage - 1 %>" class="page-link">Previous</a>
            </li>
          <% } %>
          <% for(let i = 1; i <= totalPages; i++) { %>
            <li class="page-item <%= i === currentPage ? 'active' : '' %>">
              <a href="/admin/managermanagement?page=<%= i %>" class="page-link"><%= i %></a>
            </li>
          <% } %>
          <% if(currentPage < totalPages) { %>
            <li class="page-item">
              <a href="/admin/managermanagement?page=<%= currentPage + 1 %>" class="page-link">Next</a>
            </li>
          <% } %>
        </ul>
      </div>
      
    </div>
  </div> 
  
  <!-- Modal for creating drop points -->
  <div class="modal fade" id="registerManagerModal" tabindex="-1" role="dialog"
    aria-labelledby="registerManagerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg my-modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="registerManagerModalLabel">Register a Manager</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form action="/admin/managermanagement" method="post">
            <div class="row">
              <!-- First Column -->
              <div class="col-md-6">
                <div class="form-group">
                  <label for="managerFirstName">First Name</label>
                  <input type="text" name="firstName" class="form-control" id="managerFirstName"
                    placeholder="Enter manager's first name">
                </div>
                <div class="form-group">
                  <label for="managerLastName">Last Name</label>
                  <input type="text" name="lastName" class="form-control" id="managerLastName"
                    placeholder="Enter manager's last name">
                </div>
                <div class="form-group">
                  <label for="managerEmail">Email</label>
                  <input type="email" name="email" class="form-control" id="managerEmail"
                    placeholder="Enter manager's email">
                </div>
              </div>
              <!-- Second Column -->
              <div class="col-md-6">
                <div class="form-group">
                  <label for="managerPhone">Phone Number</label>
                  <input type="tel" name="phoneNumber" class="form-control" id="managerPhone"
                    placeholder="Enter manager's phone number">
                </div>
                <div class="form-group">
                  <label for="managerAddress">Address</label>
                  <input type="text" name="address" class="form-control" id="managerAddress"
                    placeholder="Enter manager's address">
                </div>
              </div>
            </div>
            <div class="modal-footer d-flex justify-content-center"> <!-- Add these classes -->
              <button type="submit" class="btn btn-primary" id="registerManagerButton">Register Manager</button>
            </div>
          </form>
        </div>

      </div>
    </div>
  </div> 

  <!-- Load Bootstrap JS (you can also include jQuery for additional functionality) -->
  <!-- <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script> -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script>
    $(document).ready(function() {
      $('.details-button').on('click', function() {
        const managerId = $(this).data('manager-id');
        const logsTab = $('#logs-' + managerId);
        const donationsTab = $('#donations-' + managerId);
        const feedbacksTab = $('#feedback-' + managerId);
  
        $.get('/admin/managermanagement/logs/' + managerId, function(activityLogs) {
          // Clear existing content
          logsTab.empty();
  
          // Check if there are any activities
          if (activityLogs.length === 0) {
            logsTab.append('<p>No activities recorded.</p>');
          } else {
            // Start the table
            var tableHtml = '<table class="table"><thead><tr><th>Type</th><th>Donation ID</th><th>Organization</th><th>Drop Point</th><th>Date</th></tr></thead><tbody>';
  
            // Populate logs tab with activity data
            activityLogs.forEach(log => {
              tableHtml += `<tr>
                              <td>${log.type}</td>
                              <td>${log.donationId}</td>
                              <td>${log.organizationName}</td>
                              <td>${log.dropPointName}</td>
                              <td>${new Date(log.date).toLocaleString()}</td>
                            </tr>`;
            });
  
            // Close the table
            tableHtml += '</tbody></table>';
  
            logsTab.append(tableHtml);
          }
        }).fail(function() {
          logsTab.html('<p>Error loading activities</p>');
        });

        $.get('/admin/managermanagement/donations/' + managerId, function(donations) {
          // Clear existing content
          donationsTab.empty();

          if (donations.length === 0) {
            donationsTab.append('<p>No donations managed.</p>');
          } else {
            var tableHtml = '<table class="table"><thead><tr><th>ID</th><th>Organization</th><th>Drop Point</th><th>Status</th><th>Date</th></tr></thead><tbody>';

            donations.forEach(donation => {
              tableHtml += `<tr>
                              <td>${donation.id}</td>
                              <td>${donation.organization.organizationname}</td>
                              <td>${donation.dropPoint.name}</td>
                              <td>${donation.status || 'Not Updated'}</td>
                              <td>${new Date(donation.createdAt).toLocaleString()}</td>
                            </tr>`;
            });

            tableHtml += '</tbody></table>';
            donationsTab.append(tableHtml);
          }
        }).fail(function() {
          donationsTab.html('<p>Error loading donations</p>');
        });

        $.get('/admin/managermanagement/feedbacks/' + managerId, function(feedbacks) {
          // Clear existing content
          feedbacksTab.empty();

          if (feedbacks.length === 0) {
            feedbacksTab.append('<p>No feedbacks received.</p>');
          } else {
            var tableHtml = '<table class="table"><thead><tr><th>ID</th><th>Organization</th><th>Drop Point</th><th>Rating</th><th>Content</th><th>Date</th></tr></thead><tbody>';

            feedbacks.forEach(feedback => {
              tableHtml += `<tr>
                              <td>${feedback.id}</td>
                              <td>${feedback.organization.organizationname}</td>
                              <td>${feedback.dropPoint.name}</td>
                              <td>${feedback.rating}</td>
                              <td>${feedback.content}</td>
                              <td>${new Date(feedback.createdAt).toLocaleString()}</td>
                            </tr>`;
            });

            tableHtml += '</tbody></table>';
            feedbacksTab.append(tableHtml);
          }
        }).fail(function() {
          feedbacksTab.html('<p>Error loading feedbacks</p>');
        });

      });
    });
  </script>
  

</body>

</html>